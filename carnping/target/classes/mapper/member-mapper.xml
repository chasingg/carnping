<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="memberMapper">

	<resultMap id="memberResultSet" type="Member">
		<result column="MEM_NO" property="memNo"/>
		<result column="MEM_ID" property="memId"/>
		<result column="MEM_PWD" property="memPwd"/>
		<result column="MEM_NAME" property="memName"/>
		<result column="NICKNAME" property="nickName"/>
		<result column="EMAIL" property="email"/>
		<result column="ENROLL_DATE" property="enrollDate"/>
		<result column="STATUS" property="status"/>
		<result column="MEM_IMG_ORIGIN" property="memImgOrigin"/>
		<result column="MEM_IMG_CHANGE" property="memImgChange"/>
		<result column="PHONE" property="phone"/>
		<result column="MEM_API_TYPE" property="memApiType"/>
		<result column="MEM_API_TOKEN" property="memApiToken"/>
		<result column="MARKETING" property="marketing"/>
		
	</resultMap>

	<resultMap id="memberReportResultSet" type="MemberReport">
		<result column="REPORT_NO" property="reportNo"/>
		<result column="REPORTED_MEM_NO" property="reportedMemNo"/>
		<result column="REPORER_MEM_NO" property="reportMemNo"/>
		<result column="REPORT_COUNT" property="reportCount"/>
		<result column="SUSPEND_COUNT" property="suspendCount"/>
	</resultMap>

	<resultMap id="questionResultSet" type="Question">
		<result column="QUE_NO" property="queNo"/>
		<result column="QUE_CATEGORY" property="queCategory"/>
		<result column="QUE_TITLE" property="queTitle"/>
		<result column="QUE_CONTENT" property="queContent"/>
		<result column="QUE_DATE" property="queDate"/>
		<result column="QUE_STATUS" property="queStatus"/>
		<result column="QUE_ANSWER" property="queAnswer"/>
		<result column="MEM_NO" property="memNo"/>
		<result column="MEM_ID" property="memId"/>
	</resultMap>
	
	<resultMap id="reportResultSet" type="Report">
		<result column="REPORT_NO" property="reportNo"/>
		<result column="MEM_NO" property="memNo"/>
		<result column="REPORT_REFNO" property="reportRefNo"/>
		<result column="REPORT_DATE" property="reportDate"/>
		<result column="REPORT_DETAIL" property="reportDetail"/>
	</resultMap>
	
	<resultMap id="chatResultSet" type="Chat">
		<result column="CHAT_NO" property="chatNo"/>
		<result column="CHAT_COMMENT" property="chatComment"/>
		<result column="MEM_NO" property="memNo"/>
		<result column="CHAT_CREATE_DATE" property="chatCreateDate"/>
	</resultMap>
	
	<resultMap id="likeResultSet" type="Like">
		<result column="MEM_NO" property="memNo"/>
		<result column="CINFO_NO" property="cinfoNo"/>
		<result column="LIKE_STATUS" property="likeStatus"/>
	</resultMap>
	
	<select id="emailCheck" resultType="_int"> 
	select
		   count(*)
	  from
	       member
     where email = #{email}
	</select>
	
	<select id="findIdByEmailCheck" resultType="_int">
	select
		   count(*)
	  from
	       member
     where mem_name = #{memName}
       and email = #{email}
	</select>
	
	<select id="findIdByEmail" resultMap="memberResultSet">
	select
	       concat(substr(mem_id, 1, 4), lpad('*', length(mem_id) - 4, '*')) "mem_id",
           to_CHAR(enroll_date,'YYYY-MM-DD') "enroll_date",
		   mem_img_change

	  from
	       member
     where mem_name = #{memName}
       and email = #{email}
	</select>
	
	<select id="findPwdCheck"  resultType="_int">
	select
		   count(*)
	  from
	       member
     where mem_id = #{memId}
       and mem_name = #{memName}
       and email = #{email}
	</select>
	
	<update id="updatePwd">
	update
		   member
	   set 
	       mem_pwd = #{memPwd}
	 where mem_id = #{memId}
       and mem_name = #{memName}
       and email = #{email}
	
	</update>
	
	<select id="idCheck" resultType="_int"> 
	select
		   count(*)
	  from
	       member
     where mem_id = #{checkId}
	</select>
	
	<select id="nicknameCheck" resultType="_int"> 
	select
		   count(*)
	  from
	       member
     where nickname = #{nickName}
	</select>
	
	<insert id="insertMember" >
		insert
		  into member
		     (
		       MEM_NO
		     , MEM_ID
		     , MEM_PWD
		     , MEM_NAME
		     , NICKNAME
		     , EMAIL
		     , ENROLL_DATE
		     , STATUS
		     , MEM_IMG_ORIGIN
		     , MEM_IMG_CHANGE
		     , PHONE
		     , MEM_API_TYPE
		     , MEM_API_TOKEN
		     , MARKETING
		     )
	    values
	         (
	           'MEM' || TO_CHAR(SEQ_MEM_NO.NEXTVAL)
	         , #{memId}
	         , #{memPwd}
	         , #{memName}
	         , #{nickName}
	         , #{email}
	         , DEFAULT
	         , DEFAULT
	         , #{memImgOrigin}
	         , #{memImgChange}
	         , #{phone}
	         , #{memApiType}
	         , #{memApiToken}
	         , #{marketing}
	         )
	</insert>


	<select  id="selectMemberList" resultMap="memberResultSet">
	SELECT
	         MEM_NO
	        ,MEM_ID
	        ,MEM_PWD
	        ,MEM_NAME
	        ,NICKNAME
	        ,EMAIL
	        ,ENROLL_DATE
	        ,STATUS
	        , MEM_IMG_ORIGIN
	        , MEM_IMG_CHANGE
	        ,PHONE
	        ,MEM_API_TYPE
	        ,MEM_API_TOKEN
	        ,MARKETING
	 FROM MEMBER
	WHERE MEM_ID != 'ADMIN'
	</select>
	
	<select id="loginMember" resultMap="memberResultSet">
	    SELECT
	          MEM_NO
	        , MEM_ID
	        , MEM_PWD
	        , MEM_NAME
	        , NICKNAME
	        , EMAIL
	        , ENROLL_DATE
	        , STATUS
	        , MEM_IMG_ORIGIN
	        , MEM_IMG_CHANGE
	        , PHONE
	        , MEM_API_TYPE
	        , MEM_API_TOKEN
	        , MARKETING
		 FROM MEMBER
		WHERE MEM_ID = #{memId} OR EMAIL = #{email}
		  AND STATUS = 'Y'
	</select>
	

	




<!-- 소영시작 -->

	<!-- 소영: 유저의 정보 조회 -->
	<select id="selectMember" resultMap="memberResultSet">
		SELECT
				MEM_NO
			  , MEM_ID
			  , MEM_PWD
			  , MEM_NAME
			  , NICKNAME
			  , EMAIL
			  , ENROLL_DATE
			  , STATUS
			  , MEM_IMG_ORIGIN
			  , PHONE
			  , MEM_API_TYPE
			  , MEM_API_TOKEN
			  , MARKETING
			  , MEM_IMG_CHANGE
	 FROM MEMBER
	WHERE MEM_ID = #{memID}
	</select>
	
	<!-- 소영 : 닉네임 업데이트  -->
	<update id="nickNameUpdate">
		update
			   member
		   set nickname = #{nickName}
		 where mem_id = #{memId}
	</update>


	<!-- 소영 : 비번 업데이트  -->
	<update id="passwordUpdate">
		update
			    member
		    set mem_pwd = #{memPwd}
		  where mem_id = #{memId}
	</update>
	
	<!-- 소영 : 프로필 전체 업데이트  -->
	<update id="updateProfile">
	    UPDATE
				MEMBER
	  	 SET 
               MEM_PWD = #{memPwd}
             , NICKNAME = #{nickName}
             , EMAIL = #{email}
             , MEM_IMG_ORIGIN = #{memImgOrigin}
             , MEM_IMG_CHANGE = #{memImgChange}
             , PHONE = #{phone}
  	   WHERE MEM_ID = #{memId}
	</update>

	<!-- 소영 : 내 문의사항 갯수 조회 (페이징)  -->
	<select id="selectQuestionListCount" resultType="_int">
		SELECT
  	  		 COUNT(*)
  	  	FROM QUESTION
  	   WHERE QUE_STATUS = 'T' OR QUE_STATUS = 'Y'
       AND MEM_NO = (SELECT MEM_NO FROM MEMBER WHERE MEM_ID = #{memId})
	</select>

	<!-- 소영 : 내 문의 사항 목록 조회  -->
	<select id="questionSelectList" resultMap="questionResultSet">
		SELECT  
				QUE_NO
			  , QUE_CATEGORY
			  ,	QUE_TITLE
			  ,	QUE_CONTENT
			  ,	QUE_DATE
			  ,	QUE_STATUS
			  ,	QUE_ANSWER
			  ,	MEM_ID
		   FROM QUESTION
		   JOIN MEMBER 
		  USING (MEM_NO)
		  WHERE MEM_ID = #{memId}
		    AND QUE_STATUS = 'T' OR QUE_STATUS = 'Y'
		    order by QUE_NO desc
	</select>

	<!-- 소영 : 문의하기 내용 조회 -->
	<select id="selectQuestion" resultMap="questionResultSet">
		SELECT  
				QUE_NO
			  , QUE_CATEGORY
			  ,	QUE_TITLE
			  ,	QUE_CONTENT
			  ,	QUE_DATE
			  ,	QUE_STATUS
			  ,	QUE_ANSWER
			  , MEM_NO
			  ,	MEM_ID
		   FROM QUESTION
		   JOIN MEMBER 
		  USING (MEM_NO)
		  WHERE QUE_NO = #{queNo}
	</select>

	<!-- 소영 : 문의하기 인서트 -->
	<insert id="insertQuestion">
		INSERT 
    	  INTO QUESTION 
             ( QUE_NO
             , QUE_CATEGORY
             , QUE_TITLE
             , QUE_CONTENT
             , MEM_NO
             )
      	VALUES 
             (
               'QUE'||SEQ_QUE_NO.NEXTVAL
              , #{queCategory}
              , #{queTitle}
              , #{queContent}
              ,(SELECT MEM_NO 
           FROM MEMBER 
          WHERE MEM_ID = #{memId}))
	</insert>

	<!-- 소영 : 문의하기 수정 업데이트  -->
	<update id="updateQuestion">
        update
               QUESTION
           SET QUE_CATEGORY = #{queCategory}
	   		 , QUE_TITLE = #{queTitle}
			 , QUE_CONTENT = #{queContent}
			 , QUE_DATE = SYSDATE
         WHERE QUE_NO = #{queNo}
	</update>

	<!-- 소영 : 문의하기 삭제하기  -->
	<update id="deleteQuestion">
		UPDATE
			   QUESTION 
		   SET QUE_STATUS = 'N'     
		 WHERE QUE_NO = #{queNo} 
	</update>
	
	<!-- 소영 : 회원탈퇴  -->
	<update id="deleteMember">
        UPDATE
               MEMBER
           SET STATUS = 'N'
         WHERE MEM_ID = #{memId}
	</update>
	
	<!-- 소영 : 내 like 갯수 조회 (페이징)  -->
	<select id="selectMyLikeListCount" resultType="_int">
		SELECT
		       COUNT(*)
		  FROM TB_LIKE
		 WHERE LIKE_STATUS = 'Y'
		   AND MEM_NO = (SELECT MEM_NO FROM MEMBER WHERE MEM_ID = #{memId})
	</select>
	
	<!-- 소영 : 내 like 갯수 조회 (페이징)  -->
	<select id="selectLikeCount" resultType="_int">
		SELECT 
		        COUNT(*)
		  FROM TB_LIKE
		 WHERE MEM_NO = (SELECT MEM_NO FROM MEMBER WHERE MEM_ID = #{memNo})
		   AND LIKE_STATUS ='Y' 
		   AND CINFO_NO = #{cinfoNo}
	</select>
	
	<!-- 소영 : 좋아요 삭제 (해제)  -->
	<update id="deleteLike">
        UPDATE 
        	   TB_LIKE
           SET LIKE_STATUS = 'N'
         WHERE CINFO_NO = #{cinfoNo}
	</update>
	
	<!-- 소영 : 좋아요 업데이트   -->
	<update id="updateInsertLike">
        UPDATE 
        	   TB_LIKE
           SET LIKE_STATUS = 'Y'
         WHERE CINFO_NO = #{cinfoNo}
	</update>
	
	<!-- 소영 : like가 존재하는지 조회 (페이징)  -->
	<select id="selectLike" resultType="_int">
		SELECT 
		        COUNT(*)
		  FROM TB_LIKE
		 WHERE MEM_NO = (SELECT MEM_NO FROM MEMBER WHERE MEM_ID = #{memNo})
		   AND CINFO_NO = #{cinfoNo}
	</select>
	
	<!-- 소영 : 좋아요 인서트 -->
	<insert id="insertLike">
		INSERT 
		  INTO TB_LIKE
			 (
			   MEM_NO,
			   CINFO_NO,
			   LIKE_STATUS
			 )
		VALUES
			 (
			   (SELECT M.MEM_NO FROM MEMBER M WHERE MEM_ID = #{memNo})
			 , #{cinfoNo}
			 , 'Y'
			 )
	</insert>
	
	
</mapper>
